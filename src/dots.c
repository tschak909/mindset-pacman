/**
 * Dot handling
 */

#include <i86.h>
#include <string.h>
#include "dots.h"

const unsigned short dot_to_pixel_x[]={2,8,14,20,26,32,38,44,50,56,62,68,74,80,86,92,98,104,110,116,122,128,134,140,146,152,158,164,170,176,182,188};

const unsigned short dot_to_pixel_y[]={4,10,16,22,28,34,40,46,52,58,64,70,76,82,88,94,100,106,112,118,124,130,136,142,148,154,160,166,172,178,184,190};

const unsigned char dotmap_new[1024]=
  {
   0xfc, 0xfc, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfc, 0xfc,
   0xfc, 0xfc, 0xff, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0xff, 0xff, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0xff, 0xfc, 0xfc, 
   0xfc, 0xfc, 0xff, 0x01, 0xff, 0xff, 0xff, 0xff, 0x01, 0xff, 0xff, 0xff, 0xff, 0xff, 0x01, 0xff, 0xff, 0x01, 0xff, 0xff, 0xff, 0xff, 0xff, 0x01, 0xff, 0xff, 0xff, 0xff, 0x01, 0xff, 0xfc, 0xfc, 
   0xfc, 0xfc, 0xff, 0x02, 0xff, 0xff, 0xff, 0xff, 0x01, 0xff, 0xff, 0xff, 0xff, 0xff, 0x01, 0xff, 0xff, 0x01, 0xff, 0xff, 0xff, 0xff, 0xff, 0x01, 0xff, 0xff, 0xff, 0xff, 0x02, 0xff, 0xfc, 0xfc, 
   0xfc, 0xfc, 0xff, 0x01, 0xff, 0xff, 0xff, 0xff, 0x01, 0xff, 0xff, 0xff, 0xff, 0xff, 0x01, 0xff, 0xff, 0x01, 0xff, 0xff, 0xff, 0xff, 0xff, 0x01, 0xff, 0xff, 0xff, 0xff, 0x01, 0xff, 0xfc, 0xfc, 
   0xfc, 0xfc, 0xff, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0xff, 0xfc, 0xfc, 
   0xfc, 0xfc, 0xff, 0x01, 0xff, 0xff, 0xff, 0xff, 0x01, 0xff, 0xff, 0x01, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x01, 0xff, 0xff, 0x01, 0xff, 0xff, 0xff, 0xff, 0x01, 0xff, 0xfc, 0xfc, 
   0xfc, 0xfc, 0xff, 0x01, 0xff, 0xff, 0xff, 0xff, 0x01, 0xff, 0xff, 0x01, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x01, 0xff, 0xff, 0x01, 0xff, 0xff, 0xff, 0xff, 0x01, 0xff, 0xfc, 0xfc, 
   0xfc, 0xfc, 0xff, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0xff, 0xff, 0x01, 0x01, 0x01, 0x01, 0xff, 0xff, 0x01, 0x01, 0x01, 0x01, 0xff, 0xff, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0xff, 0xfc, 0xfc, 
   0xfc, 0xfc, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x01, 0xff, 0xff, 0xff, 0xff, 0xff, 0xFE, 0xff, 0xff, 0xFE, 0xff, 0xff, 0xff, 0xff, 0xff, 0x01, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfc, 0xfc, 
   0xfc, 0xfc, 0xFE, 0xFE, 0xFE, 0xFE, 0xFE, 0xff, 0x01, 0xff, 0xff, 0xff, 0xff, 0xff, 0xFE, 0xff, 0xff, 0xFE, 0xff, 0xff, 0xff, 0xff, 0xff, 0x01, 0xff, 0xFE, 0xFE, 0xFE, 0xFE, 0xFE, 0xfc, 0xfc, 
   0xfc, 0xfc, 0xFE, 0xFE, 0xFE, 0xFE, 0xFE, 0xff, 0x01, 0xff, 0xff, 0xFE, 0xFE, 0xFE, 0xFE, 0xFE, 0xFE, 0xFE, 0xFE, 0xFE, 0xFE, 0xff, 0xff, 0x01, 0xff, 0xFE, 0xFE, 0xFE, 0xFE, 0xFE, 0xfc, 0xfc, 
   0xfc, 0xfc, 0xFE, 0xFE, 0xFE, 0xFE, 0xFE, 0xff, 0x01, 0xff, 0xff, 0xFE, 0xff, 0xff, 0xff, 0xFD, 0xFD, 0xff, 0xff, 0xff, 0xFE, 0xff, 0xff, 0x01, 0xff, 0xFE, 0xFE, 0xFE, 0xFE, 0xFE, 0xfc, 0xfc, 
   0xfc, 0xfc, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x01, 0xff, 0xff, 0xFE, 0xff, 0xFE, 0xFE, 0xFE, 0xFE, 0xFE, 0xFE, 0xff, 0xFE, 0xff, 0xff, 0x01, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfc, 0xfc, 
   0xfc, 0xfc, 0xFE, 0xFE, 0xFE, 0xFE, 0xFE, 0xFE, 0x01, 0xFE, 0xFE, 0xFE, 0xff, 0xFE, 0xFE, 0xFE, 0xFE, 0xFE, 0xFE, 0xff, 0xFE, 0xFE, 0xFE, 0x01, 0xFE, 0xFE, 0xFE, 0xFE, 0xFE, 0xFE, 0xfc, 0xfc, 
   0xfc, 0xfc, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x01, 0xff, 0xff, 0xFE, 0xff, 0xFE, 0xFE, 0xFE, 0xFE, 0xFE, 0xFE, 0xff, 0xFE, 0xff, 0xff, 0x01, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfc, 0xfc, 
   0xfc, 0xfc, 0xFE, 0xFE, 0xFE, 0xFE, 0xFE, 0xff, 0x01, 0xff, 0xff, 0xFE, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xFE, 0xff, 0xff, 0x01, 0xff, 0xFE, 0xFE, 0xFE, 0xFE, 0xFE, 0xfc, 0xfc, 
   0xfc, 0xfc, 0xFE, 0xFE, 0xFE, 0xFE, 0xFE, 0xff, 0x01, 0xff, 0xff, 0xFE, 0xFE, 0xFE, 0xFE, 0xFE, 0xFE, 0xFE, 0xFE, 0xFE, 0xFE, 0xff, 0xff, 0x01, 0xff, 0xFE, 0xFE, 0xFE, 0xFE, 0xFE, 0xfc, 0xfc, 
   0xfc, 0xfc, 0xFE, 0xFE, 0xFE, 0xFE, 0xFE, 0xff, 0x01, 0xff, 0xff, 0xFE, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xFE, 0xff, 0xff, 0x01, 0xff, 0xFE, 0xFE, 0xFE, 0xFE, 0xFE, 0xfc, 0xfc, 
   0xfc, 0xfc, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x01, 0xff, 0xff, 0xFE, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xFE, 0xff, 0xff, 0x01, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfc, 0xfc, 
   0xfc, 0xfc, 0xff, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0xff, 0xff, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0xff, 0xfc, 0xfc, 
   0xfc, 0xfc, 0xff, 0x01, 0xff, 0xff, 0xff, 0xff, 0x01, 0xff, 0xff, 0xff, 0xff, 0xff, 0x01, 0xff, 0xff, 0x01, 0xff, 0xff, 0xff, 0xff, 0xff, 0x01, 0xff, 0xff, 0xff, 0xff, 0x01, 0xff, 0xfc, 0xfc, 
   0xfc, 0xfc, 0xff, 0x01, 0xff, 0xff, 0xff, 0xff, 0x01, 0xff, 0xff, 0xff, 0xff, 0xff, 0x01, 0xff, 0xff, 0x01, 0xff, 0xff, 0xff, 0xff, 0xff, 0x01, 0xff, 0xff, 0xff, 0xff, 0x01, 0xff, 0xfc, 0xfc, 
   0xfc, 0xfc, 0xff, 0x02, 0x01, 0x01, 0xff, 0xff, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0xff, 0xff, 0x01, 0x01, 0x02, 0xff, 0xfc, 0xfc, 
   0xfc, 0xfc, 0xff, 0xff, 0xff, 0x01, 0xff, 0xff, 0x01, 0xff, 0xff, 0x01, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x01, 0xff, 0xff, 0x01, 0xff, 0xff, 0x01, 0xff, 0xff, 0xff, 0xfc, 0xfc, 
   0xfc, 0xfc, 0xff, 0xff, 0xff, 0x01, 0xff, 0xff, 0x01, 0xff, 0xff, 0x01, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x01, 0xff, 0xff, 0x01, 0xff, 0xff, 0x01, 0xff, 0xff, 0xff, 0xfc, 0xfc, 
   0xfc, 0xfc, 0xff, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0xff, 0xff, 0x01, 0x01, 0x01, 0x01, 0xff, 0xff, 0x01, 0x01, 0x01, 0x01, 0xff, 0xff, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0xff, 0xfc, 0xfc, 
   0xfc, 0xfc, 0xff, 0x01, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x01, 0xff, 0xff, 0x01, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x01, 0xff, 0xfc, 0xfc, 
   0xfc, 0xfc, 0xff, 0x01, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x01, 0xff, 0xff, 0x01, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x01, 0xff, 0xfc, 0xfc, 
   0xfc, 0xfc, 0xff, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0xff, 0xfc, 0xfc, 
   0xfc, 0xfc, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfc, 0xfc,
   0xfc, 0xfc, 0xfc, 0xfc, 0xfc, 0xfc, 0xfc, 0xfc, 0xfc, 0xfc, 0xfc, 0xfc, 0xfc, 0xfc, 0xfc, 0xfc, 0xfc, 0xfc, 0xfc, 0xfc, 0xfc, 0xfc, 0xfc, 0xfc, 0xfc, 0xfc, 0xfc, 0xfc, 0xfc, 0xfc, 0xfc, 0xfc,
  };

// Dot/collision maps for player 1 and 2.
unsigned char dotmap_0[1024];
unsigned char dotmap_1[1024];

extern const unsigned char dot[];
extern const unsigned char powerpellet[];

unsigned short dotbp[10];

/**
 * Reset dotmap (for e.g. new stage)
 */
void dots_new(unsigned char* dest)
{
  memcpy(dest,&dotmap_new,sizeof(dotmap_new));
}

/**
 * New game, initialize dotmap for player 1 and 2.
 */
void dots_new_game(void)
{
  dots_new(&dotmap_0);
  dots_new(&dotmap_1);
}

/**
 * Update a single dot position
 */
void dot_plot(unsigned char p, unsigned short d)
{
  unsigned char* dm=(p==0 ? &dotmap_0 : &dotmap_1);
  union REGPACK regs;
  
  if (dm[d]<0xFC)
    {
      // Choose appropriate bitmap.
      switch(dm[d])
	{
	case 0x01:
	  dotbp[0]=FP_OFF(dot);
	  dotbp[1]=FP_SEG(dot);
	  break;
	case 0x02:
	  dotbp[0]=FP_OFF(powerpellet);
	  dotbp[1]=FP_SEG(powerpellet);
	  break;
	}
      
      // and set the rest of the bp up.
      dotbp[2]=4; //stride, 1 empty byte.
      dotbp[3]=0;
      dotbp[4]=0;
      dotbp[5]=dot_to_pixel_x[d&0x1F];
      dotbp[6]=dot_to_pixel_y[d>>5];
      dotbp[7]=6;
      dotbp[8]=6;
      dotbp[9]=0xFFFF;
      
      regs.h.ah=0x08;       // BLT copy
      regs.h.al=1;          // BLT id
      regs.w.cx=1;          // # of blits to do
      regs.w.dx=0;          // Top/bottom, left/right normal blit
      regs.w.si=0;          // X origin
      regs.w.di=0;          // Y origin
      regs.w.es=FP_SEG(dotbp); // pointer to blitter params
      regs.w.bx=FP_OFF(dotbp); // ""      "" 
      intr(0xEF,&regs);
    }  
}

/**
 * Plot all dots for a given dotmap
 */
void dots_plot(unsigned char p)
{
  unsigned short i;
  
  for (i=0;i<sizeof(dotmap_new);i++)
    {
      dot_plot(p,i);
    }
}

/**
 * Check for wall
 */
bool dot_check_wall(unsigned char p, unsigned char tx, unsigned char ty)
{
  unsigned char d=(p==0 ? dotmap_0[(ty<<5)+tx] : dotmap_1[(ty<<5)+tx]);
  return d>0xFC;
}
